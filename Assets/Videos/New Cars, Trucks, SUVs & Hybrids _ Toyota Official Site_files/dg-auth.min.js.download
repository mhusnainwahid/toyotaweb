!function(t){var e={};function n(o){if(e[o])return e[o].exports;var i=e[o]={i:o,l:!1,exports:{}};return t[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(o,i,function(e){return t[e]}.bind(null,i));return o},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=1)}([function(t,e,n){t.exports=function(){"use strict";function t(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)t[o]=n[o]}return t}return function e(n,o){function i(e,i,s){if("undefined"!=typeof document){"number"==typeof(s=t({},o,s)).expires&&(s.expires=new Date(Date.now()+864e5*s.expires)),s.expires&&(s.expires=s.expires.toUTCString()),e=encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var r="";for(var a in s)s[a]&&(r+="; "+a,!0!==s[a]&&(r+="="+s[a].split(";")[0]));return document.cookie=e+"="+n.write(i,e)+r}}return Object.create({set:i,get:function(t){if("undefined"!=typeof document&&(!arguments.length||t)){for(var e=document.cookie?document.cookie.split("; "):[],o={},i=0;i<e.length;i++){var s=e[i].split("="),r=s.slice(1).join("=");try{var a=decodeURIComponent(s[0]);if(o[a]=n.read(r,a),t===a)break}catch(t){}}return t?o[t]:o}},remove:function(e,n){i(e,"",t({},n,{expires:-1}))},withAttributes:function(n){return e(this.converter,t({},this.attributes,n))},withConverter:function(n){return e(t({},this.converter,n),this.attributes)}},{attributes:{value:Object.freeze(o)},converter:{value:Object.freeze(n)}})}({read:function(t){return'"'===t[0]&&(t=t.slice(1,-1)),t.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(t){return encodeURIComponent(t).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}},{path:"/"})}()},function(t,e,n){"use strict";function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function i(t,e,n){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return n}function s(t,e,n){if(!e.has(t))throw new TypeError("attempted to "+n+" private field on non-instance");return e.get(t)}function r(t,e){return function(t,e){return e.get?e.get.call(t):e.value}(t,s(t,e,"get"))}function a(t,e,n){return function(t,e,n){if(e.set)e.set.call(t,n);else{if(!e.writable)throw new TypeError("attempted to set read only private field");e.value=n}}(t,s(t,e,"set"),n),n}n.r(e);var u=new WeakMap,d=new WeakMap,c=new WeakMap,l=new WeakMap,h=new WeakSet,v=new WeakSet,g=new WeakSet;class f{constructor(t,e){g.add(this),v.add(this),h.add(this),u.set(this,{writable:!0,value:void 0}),d.set(this,{writable:!0,value:new Set}),c.set(this,{writable:!0,value:!1}),l.set(this,{writable:!0,value:void 0}),a(this,u,t),a(this,l,e)}getValue(){return i(this,h,p).call(this),r(this,u)}setValue(t){r(this,u)!==t&&(a(this,u,t),r(this,d).forEach(t=>i(this,v,m).call(this,t)))}subscribe(t,{immediate:e}={}){return i(this,h,p).call(this),r(this,d).add(t),e&&i(this,v,m).call(this,t),()=>i(this,g,w).call(this,t)}}function p(){var t;r(this,c)||(a(this,c,!0),null===(t=r(this,l))||void 0===t||t.call(this))}async function m(t){await Promise.resolve(t(r(this,u)))===f.unsubscribeToken&&i(this,g,w).call(this,t)}function w(t){r(this,d).delete(t)}o(f,"unsubscribeToken",Symbol("unsubscribe"));class y{constructor(t,e,n,i){o(this,"moduleName",void 0),o(this,"minLogLevel",0),o(this,"context",void 0);const s=n?"::"+n:"";this.moduleName=`${t}${s}`,this.context=i,e&&this.setEnv(e)}setEnv(t){this.minLogLevel="prod"===t?2:"demo"===t?1:0}debug(...t){this.minLogLevel<=0&&console.debug(this.moduleName+": ",...t,this.context)}info(...t){this.minLogLevel<=1&&console.info(this.moduleName+": ",...t,this.context)}log(...t){this.minLogLevel<=1&&console.log(this.moduleName+": ",...t,this.context)}warn(...t){this.minLogLevel<=2&&console.warn(this.moduleName+": ",...t,this.context)}error(...t){this.minLogLevel<=3&&console.error(this.moduleName+": ",...t,this.context)}}const b=new y("dg-auth",void 0,void 0,{href:window.location.href});class E{constructor(){o(this,"isAuthInProgressObservable",void 0),this.isAuthInProgressObservable=new f(!1),E.setObservableOnDataHub(this.isAuthInProgressObservable)}static setObservableOnDataHub(t){var e;const n=window.DGDataHub;n?(null!==(e=n.__internal__)&&void 0!==e||(n.__internal__={}),n.__internal__.isAuthInProgress=t):setTimeout(()=>E.setObservableOnDataHub(t),50)}set isAuthInProgress(t){b.debug("Setting isAuthInProgress",t),this.isAuthInProgressObservable.setValue(t)}get isAuthInProgress(){return this.isAuthInProgressObservable.getValue()}}var k,_=n(0),S=n.n(_);class I{constructor(t){o(this,"name",void 0),this.name=t}get(){return"true"===(t=this.name,S.a.get(t));var t}set(t){var e;t?function(t,e){S.a.set(t,e,P())}(this.name,""+t):(e=this.name,S.a.remove(e,P()))}}function P(){return{domain:function(t=(()=>{var t,e;return null===(t=window)||void 0===t||null===(e=t.location)||void 0===e?void 0:e.href})()){try{const e=new URL(t).hostname.split(".");return e.length>1?e.slice(e.length-2).join("."):e[0]?e[0]:__IS_LEXUS__?"lexus.com":"tldealersystems.com"}catch{return null}}()||void 0}}!function(t){t.local="local",t.dev="dev",t.test="test",t.stage="stage",t.demo="demo",t.prod="prod"}(k||(k={}));const T=new I("dg_was_auto_logged"),O=new I("dg_show_auto_logged_out_notification");class A{constructor(t,e,n){o(this,"key",void 0),o(this,"isEqual",void 0),o(this,"sizeLimit",void 0),this.key=t,this.isEqual=n,this.sizeLimit=e}addItem(t){const e=this.items;return e.some(e=>this.isSameItem(e,t))?(b.debug("Skipping add because it is already in the list",t),!1):(this.items=[...e,t],!0)}get items(){try{const t=S.a.get(this.key),e=t?JSON.parse(t):[];return Array.isArray(e)?e:[]}catch{return[]}}set items(t){const e=t.slice(-this.sizeLimit),n=JSON.stringify(e);S.a.withConverter({write:t=>t.toString()}).set(this.key,n,{domain:".toyota.com"})}removeItem(t){this.items=this.items.filter(e=>!this.isSameItem(e,t))}isSameItem(t,e){return"function"==typeof this.isEqual?this.isEqual(t,e):t===e}}var L;function C(t){if(!function(t){if(!t||"object"!=typeof t)throw new j("Must be a truthy object",t);const e=Object.keys(t||{});if(1!==e.length)throw new j("Must have only one key",t);const n=e[0];if(!function(t){return Object.values(L).includes(t)}(n))throw new j(`Key must be an event type, not '${n}'`,t);const o=t[n];if(null==o||!o.env)throw new j("Data must contain an 'env' property",t);if(null==o||!o.requestId)throw new j("Data must contain a 'requestId' property",t);return!0}(t))throw new Error("Invalid event");const e=Object.keys(t)[0];return{type:e,data:t[e]}}function x(t,e){return t.type===e.type&&!!t.data.requestId&&t.data.requestId===e.data.requestId&&t.data.env===e.data.env}!function(t){t.tokenRequested="TOKEN_REQUESTED",t.tokenCreated="TOKEN_CREATED",t.tokenDeleted="TOKEN_DELETED"}(L||(L={}));class j extends Error{constructor(t,e){super("Invalid RawAuthEvent: "+t),o(this,"event",void 0),this.event=e}}var D={1:{[k.local]:"https://api-t1.stage.dg.toyota.com",[k.dev]:"https://api-t1.dev.dg.toyota.com",[k.test]:"https://api-t1.test.dg.toyota.com",[k.stage]:"https://api-t1.stage.dg.toyota.com",[k.demo]:"https://api-t1.demo.dg.toyota.com",[k.prod]:"https://api-t1.dg.toyota.com"},2:{[k.local]:"https://api-t1.stage.dg.toyota.com",[k.dev]:"https://api-t1.dev.dg.toyota.com",[k.test]:"https://api-t1.test.dg.toyota.com",[k.stage]:"https://api-t1.stage.dg.toyota.com",[k.demo]:"https://api-t1.demo.dg.toyota.com",[k.prod]:"https://api-t1.dg.toyota.com"},3:{[k.local]:"https://api.stage.dg.toyota.com",[k.dev]:"https://api.dev.dg.toyota.com",[k.test]:"https://api.test.dg.toyota.com",[k.stage]:"https://api.stage.dg.toyota.com",[k.demo]:"https://api.demo.dg.toyota.com",[k.prod]:"https://api.dg.toyota.com"}};function H(t){this.message=t}H.prototype=new Error,H.prototype.name="InvalidCharacterError";var N="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(t){var e=String(t).replace(/=+$/,"");if(e.length%4==1)throw new H("'atob' failed: The string to be decoded is not correctly encoded.");for(var n,o,i=0,s=0,r="";o=e.charAt(s++);~o&&(n=i%4?64*n+o:o,i++%4)?r+=String.fromCharCode(255&n>>(-2*i&6)):0)o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(o);return r};function M(t){var e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw"Illegal base64url string!"}try{return function(t){return decodeURIComponent(N(t).replace(/(.)/g,(function(t,e){var n=e.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n})))}(e)}catch(t){return N(e)}}function R(t){this.message=t}R.prototype=new Error,R.prototype.name="InvalidTokenError";var U=function(t,e){if("string"!=typeof t)throw new R("Invalid token specified");var n=!0===(e=e||{}).header?0:1;try{return JSON.parse(M(t.split(".")[n]))}catch(t){throw new R("Invalid token specified: "+t.message)}};const q=new y("getIdToken");function W(t){const e=S.a.get(t);if("string"==typeof e){if(function(t){if(!t)return!1;try{return Object.keys(U(t)).length>0}catch{return q.debug("Invalid JWT provided"),!1}}(e))return{isValidJWT:!0,jwt:e};if("true"===e.toLowerCase())return{pkceSaysTheyAreLoggedIn:!0}}return{}}function B(t){return new Promise(e=>setTimeout(e,t))}const V={delayMs:100,timeoutMs:1e3,suppressErrors:!1};function J(t,e){const n={...V,...e};return function(t,e){const n={isCanceled:!1},o=setTimeout(()=>n.isCanceled=!0,t);return e(n).finally(()=>clearTimeout(o))}(n.timeoutMs,async e=>{for(;!e.isCanceled;){try{const e=t();if(e)return e}catch(t){if(!n.suppressErrors)throw t}await B(n.delayMs)}return t()})}var z={MstcSubdomain:{toyota:"smartpath",lexus:"monogram"},defaultBuildsRoute:{toyota:"/configurator",lexus:"/build-your-lexus/#!/series"},tierPatterns:{t1ToyotaPattern:".toyota.com",t2ToyotaPattern:".buyatoyota.com",t2ToyotaSubprodPattern:".nonprod.jsds.tms.aws.toyota.com",t1LexusPattern:".lexus.com"}};const F={};async function K(t){const e=F[t];if(e)return e;const n=async function(t){return new $(t)}(t);return F[t]=n,n}class ${constructor(t){o(this,"env",void 0),this.env=t}handleLogin(){const t=this.getBaseUrl()+"/garage/v2/auth/events/login",e=this.buildBody();return e.dgid?e.id_token?G(t,e):(b.info("No id_token, skipping login event POST"),null):(b.info("No dgid, skipping login event POST"),null)}handleLogout(){const t=this.getBaseUrl()+"/garage/v2/auth/events/logout",e=this.buildBody();return e.dgid?G(t,e):(b.info("No dgid, skipping logout event POST"),null)}getBaseUrl(){const t=D[function(){const t=window.location.hostname;return t.includes(z.tierPatterns.t2ToyotaPattern)||t.includes(z.tierPatterns.t2ToyotaSubprodPattern)?2:t.includes(z.tierPatterns.t1ToyotaPattern)||t.includes(z.tierPatterns.t1LexusPattern)&&!t.includes(z.MstcSubdomain.lexus)?1:3}()][this.env];if(!t)throw new Error(`No dgApi url found for env: '${this.env}'`);return t}buildBody(){var t;const e=this.getDgid(),{value:n,reason:o}=this.getIdToken();return{dgid:e,id_token:n,meta:{reason:o,source:null!==(t=window.location.href)&&void 0!==t?t:"unknown"}}}getDgid(){const t="dgid_"+this.env;return S.a.get(t)}getIdToken(){const t="prod"===this.env?"id_token":"id_token_tmnab2cqa";return this.getIdTokenValueWithReason(t)}getIdTokenValueWithReason(t){const e=W(t);if(e.isValidJWT)return{value:e.jwt,reason:"valid_jwt"};if(e.pkceSaysTheyAreLoggedIn){b.debug("Getting id_token information from local storage");const e=localStorage.getItem(t);return e?{value:e,reason:"pkce_use_local_token"}:{value:null,reason:"pkce_no_local_token"}}return{value:null,reason:"catch_all_invalid_token"}}}async function G(t,e){var n,o;return await J(()=>window.AwsWafIntegration,{delayMs:100,timeoutMs:5e3})?fetch(t,{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json","X-Aws-Waf-Token":null!==(n=await(null===(o=window.AwsWafIntegration)||void 0===o?void 0:o.getToken()))&&void 0!==n?n:"No Challenge Loaded"}}):(b.warn("Challenge script not loaded. Skipping event",e),null)}class Q{constructor(t){o(this,"authState",void 0),o(this,"inProgressEvents",void 0),o(this,"finishedEvents",void 0),this.authState=t,this.inProgressEvents=new A("dg-auth-events-in-progress",5,x),this.finishedEvents=new A("dg-auth-events-finished",5,x)}async finishPendingEvents(){const t=this.inProgressEvents.items;if(t.length>0){b.debug("Finishing pending events",t);for(const e of t)await this.handleEvent(e)}}queueEvents(t){if(t.length>0){b.debug("Queueing events",t);for(const e of t)this.setEventHandlingState("started",e)}}async handleEvent(t){if(this.eventHasAlreadyBeenHandled(t))return b.debug("Skipping event, because it was already handled",t),void this.setEventHandlingState("finished",t);b.info("Handling event",t),this.setEventHandlingState("started",t);try{await this._handleEvent(t),b.debug("Successfully handled event",t)}catch(e){b.error("Error handling event",t,e)}finally{this.setEventHandlingState("finished",t)}}_setAutoLogoutEventCookies(){T.set(!0),O.set(!0)}_removeAutoLogoutEventCookies(){T.set(!1),O.set(!1)}async _handleEvent(t){var e,n;let o=null===(e=window.DGDataHub)||void 0===e||null===(n=e.DEPLOY_ENV)||void 0===n?void 0:n.toLowerCase();if(!o){const t="__dg_override_env__",e=window.localStorage.getItem(t)||window.sessionStorage.getItem(t);o=null==e?void 0:e.toLowerCase()}const i=o||t.data.env;switch(b.setEnv(i),t.type){case L.tokenRequested:this.authState.isAuthInProgress=!0;break;case L.tokenCreated:await this.processAuth(()=>async function(t){return(await K(t)).handleLogin()}(i)),this._removeAutoLogoutEventCookies();break;case L.tokenDeleted:await this.processAuth(()=>async function(t){return(await K(t)).handleLogout()}(i)),"SESSION_TIMEOUT"===t.data.logout_reason&&this._setAutoLogoutEventCookies();break;default:b.warn("Invalid event type: "+t.type)}}async processAuth(t){this.authState.isAuthInProgress=!0;try{await t()}finally{this.authState.isAuthInProgress=!1}}eventHasAlreadyBeenHandled(t){return this.finishedEvents.items.some(e=>x(e,t))}setEventHandlingState(t,e){"started"===t?this.inProgressEvents.addItem(e):"finished"===t&&(this.inProgressEvents.removeItem(e),this.finishedEvents.addItem(e))}}async function X(){return function(t){if(!t)throw new Error("Event Hub was not truthy");if(!Array.isArray(t.events))throw new Error("Event Hub did not have 'events' property that is an array");return t}(await J(Y,{delayMs:50,timeoutMs:1e4}))}function Y(){var t;return null===(t=window.pkce)||void 0===t?void 0:t.eventHistory}class Z{constructor(t){o(this,"windowEventHub",void 0),this.windowEventHub=t}getEvents(){const t=this.windowEventHub.events;if(!Array.isArray(t))throw new Error("Event history must be an array");return t.map(t=>C(t)).reduce((t,e)=>{const n=e.type===L.tokenRequested||e.type===L.tokenDeleted?[]:t;return n.push(e),n},[])}}(async function(){try{const t=new E,e=await async function(){try{return await async function(){const t=await X();return new Z(t)}()}catch(t){return b.warn("Unable to create Event Hub",t),null}}();if(!e)return;b.debug("Handling events"),await async function(t,e){const n=new Q(e);window.addEventListener("beforeunload",()=>{const e=t.getEvents();b.debug("Queueing events",JSON.stringify(e)),n.queueEvents(e)}),await n.finishPendingEvents();const o=t.getEvents();for(const t of o)await n.handleEvent(t)}(e,t),b.debug("Finished handling events")}catch(t){b.error(t)}})()}]);
//# sourceMappingURL=dg-auth.min.js.map